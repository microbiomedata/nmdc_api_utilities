

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>nmdc_api_utilities.collection_search &mdash; nmdc_api_utilities 2/1/2025 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../_static/css/theme.css?v=e59714d7" />

  
      <script src="../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../_static/documentation_options.js?v=62c20008"></script>
      <script src="../../_static/doctools.js?v=9bcbadda"></script>
      <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            nmdc_api_utilities
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../functions.html">NMDC API Utilities Documentation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../usage.html">NMDC API Utilities Usage Notes</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">nmdc_api_utilities</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Module code</a></li>
      <li class="breadcrumb-item active">nmdc_api_utilities.collection_search</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for nmdc_api_utilities.collection_search</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">nmdc_api_utilities.data_processing</span> <span class="kn">import</span> <span class="n">DataProcessing</span>
<span class="kn">import</span> <span class="nn">urllib.parse</span>
<span class="kn">from</span> <span class="nn">nmdc_api_utilities.nmdc_search</span> <span class="kn">import</span> <span class="n">NMDCSearch</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">re</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="kn">import</span> <span class="nn">json</span>


<div class="viewcode-block" id="CollectionSearch">
<a class="viewcode-back" href="../../functions.html#nmdc_api_utilities.collection_search.CollectionSearch">[docs]</a>
<span class="k">class</span> <span class="nc">CollectionSearch</span><span class="p">(</span><span class="n">NMDCSearch</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to interact with the NMDC API to get collections of data. Must know the collection name to query.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">collection_name</span><span class="p">,</span> <span class="n">env</span><span class="o">=</span><span class="s2">&quot;prod&quot;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span> <span class="o">=</span> <span class="n">collection_name</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">env</span><span class="o">=</span><span class="n">env</span><span class="p">)</span>

<div class="viewcode-block" id="CollectionSearch.get_records">
<a class="viewcode-back" href="../../functions.html#nmdc_api_utilities.collection_search.CollectionSearch.get_records">[docs]</a>
    <span class="k">def</span> <span class="nf">get_records</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">max_page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">all_pages</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a collection of data from the NMDC API. Generic function to get a collection of data from the NMDC API. Can provide a specific filter if desired.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filter: str</span>
<span class="sd">            The filter to apply to the query. Default is an empty string.</span>
<span class="sd">        max_page_size: int</span>
<span class="sd">            The maximum number of items to return per page. Default is 100.</span>
<span class="sd">        fields: str</span>
<span class="sd">            The fields to return. Default is all fields.</span>
<span class="sd">        all_pages: bool</span>
<span class="sd">            True to return all pages. False to return the first page. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[dict]</span>
<span class="sd">            A list of dictionaries containing the records.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the API request fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_records Filter: </span><span class="si">{</span><span class="nb">filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">filter</span> <span class="o">=</span> <span class="n">urllib</span><span class="o">.</span><span class="n">parse</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="nb">filter</span><span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_records encoded Filter: </span><span class="si">{</span><span class="nb">filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/nmdcschema/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">?filter=</span><span class="si">{</span><span class="nb">filter</span><span class="si">}</span><span class="s2">&amp;max_page_size=</span><span class="si">{</span><span class="n">max_page_size</span><span class="si">}</span><span class="s2">&amp;projection=</span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;API request failed&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to get collection from NMDC API&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;API request response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2"> API Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span>
        <span class="c1"># otherwise, get all pages</span>
        <span class="k">if</span> <span class="n">all_pages</span><span class="p">:</span>
            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_all_pages</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="nb">filter</span><span class="p">,</span> <span class="n">max_page_size</span><span class="p">,</span> <span class="n">fields</span><span class="p">)[</span>
                <span class="s2">&quot;resources&quot;</span>
            <span class="p">]</span>

        <span class="k">return</span> <span class="n">results</span></div>


    <span class="k">def</span> <span class="nf">_get_all_pages</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">requests</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">Response</span><span class="p">,</span>
        <span class="nb">filter</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">max_page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get all pages of data from the NMDC API. This is a helper function to get all pages of data from the NMDC API.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        response: requests.models.Response</span>
<span class="sd">            The response object from the API request.</span>
<span class="sd">        filter: str</span>
<span class="sd">            The filter to apply to the query. Default is an empty string.</span>
<span class="sd">        max_page_size: int</span>
<span class="sd">            The maximum number of items to return per page. Default is 100.</span>
<span class="sd">        fields: str</span>
<span class="sd">            The fields to return. Default is all fields.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[dict]</span>
<span class="sd">            A list of dictionaries containing the records.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the API request fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">results</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;next_page_token&quot;</span><span class="p">):</span>
                <span class="n">next_page_token</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;next_page_token&quot;</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">break</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/nmdcschema/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">?filter=</span><span class="si">{</span><span class="nb">filter</span><span class="si">}</span><span class="s2">&amp;max_page_size=</span><span class="si">{</span><span class="n">max_page_size</span><span class="si">}</span><span class="s2">&amp;projection=</span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">&amp;page_token=</span><span class="si">{</span><span class="n">next_page_token</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
                <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
            <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;API request failed&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to get collection from NMDC API&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;API request response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2"> API Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="n">results</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;resources&quot;</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="s2">&quot;resources&quot;</span><span class="p">]</span> <span class="o">+</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()[</span><span class="s2">&quot;resources&quot;</span><span class="p">]}</span>
        <span class="k">return</span> <span class="n">results</span>

<div class="viewcode-block" id="CollectionSearch.get_record_by_filter">
<a class="viewcode-back" href="../../functions.html#nmdc_api_utilities.collection_search.CollectionSearch.get_record_by_filter">[docs]</a>
    <span class="k">def</span> <span class="nf">get_record_by_filter</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="nb">filter</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">max_page_size</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">all_pages</span><span class="o">=</span><span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a record from the NMDC API by its id.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        filter: str</span>
<span class="sd">            The filter to use to query the collection. Must be in MonogDB query format.</span>
<span class="sd">                Resources found here - https://www.mongodb.com/docs/manual/reference/method/db.collection.find/#std-label-method-find-query</span>
<span class="sd">            Example: {&quot;name&quot;:{&quot;my record name&quot;}}</span>
<span class="sd">        max_page_size: int</span>
<span class="sd">            The number of results to return per page. Default is 25.</span>
<span class="sd">        fields: str</span>
<span class="sd">            The fields to return. Default is all fields.</span>
<span class="sd">            Example: &quot;id,name,description,alternative_identifiers,file_size_bytes,md5_checksum,data_object_type,url,type&quot;</span>
<span class="sd">        all_pages: bool</span>
<span class="sd">            True to return all pages. False to return the first page. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[dict]</span>
<span class="sd">            A list of dictionaries containing the records.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">max_page_size</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">all_pages</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="CollectionSearch.get_record_by_attribute">
<a class="viewcode-back" href="../../functions.html#nmdc_api_utilities.collection_search.CollectionSearch.get_record_by_attribute">[docs]</a>
    <span class="k">def</span> <span class="nf">get_record_by_attribute</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">attribute_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">attribute_value</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">25</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="n">all_pages</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
        <span class="n">exact_match</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a record from the NMDC API by its name. Records can be filtered based on their attributes found https://microbiomedata.github.io/nmdc-schema/.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        attribute_name: str</span>
<span class="sd">            The name of the attribute to filter by.</span>
<span class="sd">        attribute_value: str</span>
<span class="sd">            The value of the attribute to filter by.</span>
<span class="sd">        max_page_size: int</span>
<span class="sd">            The number of results to return per page. Default is 25.</span>
<span class="sd">        fields: str</span>
<span class="sd">            The fields to return. Default is all fields.</span>
<span class="sd">        all_pages: bool</span>
<span class="sd">            True to return all pages. False to return the first page. Default is False.</span>
<span class="sd">        exact_match: bool</span>
<span class="sd">            This var is used to determine if the inputted attribute value is an exact match or a partial match. Default is False, meaning the user does not need to input an exact match. Under the hood this is used to determine if the inputted attribute value should be wrapped in a regex expression.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[dict]</span>
<span class="sd">            A list of dictionaries containing the records.</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">exact_match</span><span class="p">:</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s1">&quot;:&quot;</span><span class="si">{</span><span class="n">attribute_value</span><span class="si">}</span><span class="s1">&quot;</span><span class="se">}}</span><span class="s1">&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># escape special characters - mongo db filters require special characters to be double escaped ex. GC\\-MS \\(2009\\)</span>
            <span class="n">escaped_value</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;([\W])&quot;</span><span class="p">,</span> <span class="sa">r</span><span class="s2">&quot;</span><span class="se">\\\\</span><span class="s2">\1&quot;</span><span class="p">,</span> <span class="n">attribute_value</span><span class="p">)</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">attribute_name</span><span class="si">}</span><span class="s1">&quot;:</span><span class="se">{{</span><span class="s1">&quot;$regex&quot;:&quot;</span><span class="si">{</span><span class="n">escaped_value</span><span class="si">}</span><span class="s1">&quot;,&quot;$options&quot;:&quot;i&quot;</span><span class="se">}}}}</span><span class="s1">&#39;</span>
            <span class="p">)</span>
        <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;get_record_by_attribute Filter: </span><span class="si">{</span><span class="nb">filter</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span><span class="nb">filter</span><span class="p">,</span> <span class="n">max_page_size</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">all_pages</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="CollectionSearch.get_record_by_id">
<a class="viewcode-back" href="../../functions.html#nmdc_api_utilities.collection_search.CollectionSearch.get_record_by_id">[docs]</a>
    <span class="k">def</span> <span class="nf">get_record_by_id</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">collection_id</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">max_page_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span>
        <span class="n">fields</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a collection of data from the NMDC API by id.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        collection_id: str</span>
<span class="sd">            The id of the collection.</span>
<span class="sd">        max_page_size: int</span>
<span class="sd">            The maximum number of items to return per page. Default is 100.</span>
<span class="sd">        fields: str</span>
<span class="sd">            The fields to return. Default is all fields.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[dict]</span>
<span class="sd">            A list of dictionaries containing the records.</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        RuntimeError</span>
<span class="sd">            If the API request fails.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">base_url</span><span class="si">}</span><span class="s2">/nmdcschema/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">collection_name</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">collection_id</span><span class="si">}</span><span class="s2">?max_page_size=</span><span class="si">{</span><span class="n">max_page_size</span><span class="si">}</span><span class="s2">&amp;projection=</span><span class="si">{</span><span class="n">fields</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="c1"># get the reponse</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">response</span><span class="o">.</span><span class="n">raise_for_status</span><span class="p">()</span>
        <span class="k">except</span> <span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">RequestException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;API request failed&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Failed to get collection by id from NMDC API&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">e</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;API request response: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span><span class="si">}</span><span class="se">\n</span><span class="s2"> API Status Code: </span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
        <span class="n">results</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">json</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">results</span></div>


<div class="viewcode-block" id="CollectionSearch.check_ids_exist">
<a class="viewcode-back" href="../../functions.html#nmdc_api_utilities.collection_search.CollectionSearch.check_ids_exist">[docs]</a>
    <span class="k">def</span> <span class="nf">check_ids_exist</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">ids</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">,</span> <span class="n">return_missing_ids</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check if the IDs exist in the collection.</span>

<span class="sd">        This method constructs a query to the API to filter the collection based on the given IDs, and checks if all IDs exist in the collection.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        ids : list</span>
<span class="sd">            A list of IDs to check if they exist in the collection.</span>
<span class="sd">        chunk_size : int</span>
<span class="sd">            The number of IDs to check in each query. Default is 100.</span>
<span class="sd">        return_missing_ids : bool</span>
<span class="sd">            If True, and if ids are missing in the collection, return the list of IDs that do not exist in the collection. Default is False.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        bool</span>
<span class="sd">            True if all IDs exist in the collection, False otherwise.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># chunk the input list of IDs into smaller lists of 100 IDs each</span>
        <span class="c1"># to avoid the maximum URL length limit</span>
        <span class="n">ids_test</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">ids</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">ids_test</span><span class="p">),</span> <span class="n">chunk_size</span><span class="p">):</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">ids_test</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">chunk_size</span><span class="p">]</span>
            <span class="n">filter_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;$in&quot;</span><span class="p">:</span> <span class="n">chunk</span><span class="p">}}</span>
            <span class="n">filter_json_string</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">filter_dict</span><span class="p">,</span> <span class="n">separators</span><span class="o">=</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="s2">&quot;:&quot;</span><span class="p">))</span>

            <span class="n">results</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span>
                <span class="nb">filter</span><span class="o">=</span><span class="n">filter_json_string</span><span class="p">,</span> <span class="n">max_page_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">),</span> <span class="n">fields</span><span class="o">=</span><span class="s2">&quot;id&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="ow">and</span> <span class="n">return_missing_ids</span><span class="p">:</span>
                <span class="n">missing_ids</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                    <span class="nb">set</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="o">-</span> <span class="nb">set</span><span class="p">([</span><span class="n">record</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">results</span><span class="p">])</span>
                <span class="p">)</span>
                <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">missing_ids</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">results</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">return_missing_ids</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>
        <span class="k">return</span> <span class="kc">True</span></div>


<div class="viewcode-block" id="CollectionSearch.get_batch_records">
<a class="viewcode-back" href="../../functions.html#nmdc_api_utilities.collection_search.CollectionSearch.get_batch_records">[docs]</a>
    <span class="k">def</span> <span class="nf">get_batch_records</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">id_list</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span> <span class="n">search_field</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">fields</span><span class="o">=</span><span class="s2">&quot;&quot;</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="nb">dict</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get a batch of records from the collection by a list of input IDs. This method is used to identify records that include any of the IDs from the input list, matching the search_field.</span>
<span class="sd">        This is using the MongoDB filter keyword $in to identify other records that include the input IDs.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ---------</span>
<span class="sd">        id_list: list</span>
<span class="sd">            A list of IDs to get records for.</span>
<span class="sd">        search_field: str</span>
<span class="sd">            The field to search for. This must match a field from the NMDC Schema.</span>
<span class="sd">        chunk_size: int</span>
<span class="sd">            The number of IDs to get in each query. Default is 100.</span>
<span class="sd">        fields: str</span>
<span class="sd">            The fields to return. Default is all fields.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        list[dict]</span>
<span class="sd">            A list of dictionaries containing the records.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">dp</span> <span class="o">=</span> <span class="n">DataProcessing</span><span class="p">()</span>
        <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">id_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">id_list</span><span class="p">))</span>
        <span class="n">chunks</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">split_list</span><span class="p">(</span><span class="n">input_list</span><span class="o">=</span><span class="n">id_list</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="n">chunks</span><span class="p">:</span>
            <span class="n">chunk</span> <span class="o">=</span> <span class="n">dp</span><span class="o">.</span><span class="n">_string_mongo_list</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">chunk</span><span class="p">)</span>
            <span class="nb">filter</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="se">{{</span><span class="s1">&quot;</span><span class="si">{</span><span class="n">search_field</span><span class="si">}</span><span class="s1">&quot;: </span><span class="se">{{</span><span class="s1">&quot;$in&quot;: </span><span class="si">{</span><span class="n">chunk</span><span class="si">}</span><span class="se">}}}}</span><span class="s1">&#39;</span>
            <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_records</span><span class="p">(</span>
                <span class="nb">filter</span><span class="o">=</span><span class="nb">filter</span><span class="p">,</span> <span class="n">max_page_size</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">chunk</span><span class="p">),</span> <span class="n">fields</span><span class="o">=</span><span class="n">fields</span><span class="p">,</span> <span class="n">all_pages</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="n">results</span> <span class="o">+=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">results</span></div>
</div>



<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="k">pass</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2024, Olivia Hess.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>